#!/bin/bash
# **********************************************
# **      Initialize the EasyRSA PKI          **
# **        Date : 22/09/2014                 **
# **        Autor: AndrÃ©s Amado               **
# ** Forked from : jpetazzo/dockvpn           **
# **********************************************

set -ex

source "$OPENVPN/ovpn_env.sh"

# Specify "nopass" as arg[2] to make the CA insecure (not recommended!)
nopass=$1

# Set UpPoints easy-rsa parameter settings
cat >> "$EASYRSA_VARS_FILE" <<EOF
set_var EASYRSA_REQ_COUNTRY  "BR"
set_var EASYRSA_REQ_PROVINCE "SC"
set_var EASYRSA_REQ_CITY     "Florianopolis"
set_var EASYRSA_REQ_ORG      "UpPoints"
set_var EASYRSA_REQ_EMAIL    "andres@uppoints.com"
set_var EASYRSA_REQ_OU       "DevOps"
EOF

# Provides a sufficient warning before erasing pre-existing files
easyrsa init-pki

# CA always has a password for protection in event server is compromised. The
# password is only needed to sign client/server certificates.  No password is
# needed for normal OpenVPN operation.
easyrsa build-ca $nopass

easyrsa gen-dh
openvpn --genkey --secret $OPENVPN/pki/ta.key

# For a server key with a password, manually init; this is autopilot
easyrsa build-server-full "$OVPN_CN" nopass

echo "Successfully init EasyRSA PKI config"
